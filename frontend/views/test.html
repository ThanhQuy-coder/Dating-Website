<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dating App UI - Frontend Only</title>
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
  <!-- Google Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins&display=swap" rel="stylesheet">
  <style>
    /* ========== Root & Reset ========== */
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    html, body {
      height: 100%;
      overflow: hidden; /* ẩn scroll dọc của body, vùng con sẽ scroll riêng */
    }
    body {
      display: flex;
      font-family: 'Poppins', sans-serif;
      background: #fff5f8;
      color: #333;
    }

    /* ========== Variables màu ========== */
    :root {
      --primary-color: #ff5a7d;
      --primary-color-dark: #e14c68;
      --bg-light: #fff5f8;
      --sidebar-bg: #ff5a7d;
      --text-dark: #333;
      --badge-bg: #ff3b5a;
      --card-width: 300px;
    }

    /* ========== SIDEBAR ========== */
    .sidebar {
      width: 250px;
      background-color: var(--sidebar-bg);
      color: white;
      display: flex;
      flex-direction: column;
    }
    .profile {
      display: flex;
      align-items: center;
      padding: 16px;
      gap: 10px;
    }
    .profile .avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      background-color: #fff;
      object-fit: cover;
    }
    .profile .username {
      font-weight: bold;
      font-size: 1.1rem;
      color: #fff;
    }
    .nav-icons {
      display: flex;
      justify-content: space-around;
      padding: 8px 0;
      border-top: 1px solid rgba(255,255,255,0.3);
      border-bottom: 1px solid rgba(255,255,255,0.3);
      margin: 0 16px;
    }
    .icon-btn {
      position: relative;
      width: 40px; height: 40px;
      border-radius: 50%;
      border: none;
      background-color: #fff;
      color: var(--primary-color);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1rem;
      cursor: pointer;
      transition: transform 0.2s;
    }
    .icon-btn:hover {
      transform: scale(1.1);
    }
    /* badge số hoặc chấm */
    .icon-btn .badge {
      position: absolute;
      top: -4px; right: -4px;
      background-color: var(--badge-bg);
      color: #fff;
      font-size: 0.65rem;
      padding: 2px 5px;
      border-radius: 8px;
    }

    .tab-container {
      display: flex;
      margin: 8px 12px;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
    }
    .tab-btn {
      flex: 1;
      padding: 10px 0;
      background: none;
      border: none;
      cursor: pointer;
      color: var(--text-dark);
      position: relative;
      font-weight: 500;
    }
    .tab-btn.active {
      font-family: 'Orbitron', sans-serif;
      font-weight: bold;
    }
    .tab-btn.active::after {
      content: "";
      position: absolute;
      bottom: 0;
      left: 30%;
      width: 40%;
      height: 3px;
      background: var(--primary-color);
      border-radius: 2px;
    }
    .sidebar-content {
      flex-grow: 1;
      background: #fff;
      color: var(--text-dark);
      margin: 8px 12px 12px;
      border-radius: 8px;
      overflow-y: auto;
    }
    /* Các item trong sidebar (match, message, notification) */
    .sidebar-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
    }
    .sidebar-item:last-child {
      border-bottom: none;
    }
    .sidebar-item .avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      object-fit: cover;
      margin-right: 12px;
    }
    .sidebar-item .text-group {
      display: flex;
      flex-direction: column;
    }
    .sidebar-item .name {
      font-weight: 500;
    }
    .sidebar-item .preview {
      font-size: 0.9rem;
      color: #666;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 140px;
    }
    .sidebar-item .badge {
      margin-left: auto;
      background: var(--badge-bg);
      color: #fff;
      padding: 2px 6px;
      border-radius: 8px;
      font-size: 0.75rem;
    }

    /* ========== MAIN CONTENT ========== */
    .main-content {
      flex-grow: 1;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
      background: var(--bg-light);
    }
    /* Header chung: search hoặc chat header hoặc notifications header */
    .main-header {
      display: flex;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #ccc;
      background: #fff;
      flex: 0 0 auto;
    }
    /* Search bar trong header (khi tab là match hoặc notifications có search) */
    .search-wrapper {
      position: relative;
      width: 100%;
      max-width: 500px;
    }
    .search-input {
      width: 100%;
      padding: 10px 12px 10px 36px; /* chừa 36px cho icon */
      border: 2px solid #ccc;
      border-radius: 25px;
      font-size: 1rem;
      outline: none;
      transition: border-color 0.2s;
    }
    .search-input:focus {
      border-color: var(--primary-color);
    }
    .search-icon {
      position: absolute;
      top: 50%;
      left: 12px;
      transform: translateY(-50%);
      color: #888;
      pointer-events: none;
    }

    /* Chat header: avatar + tên + actions */
    .main-header.chat-header {
      /* reuse .main-header, nhưng tránh border-bottom double */
    }
    .main-header.chat-header .avatar {
      width: 40px; height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }
    .main-header.chat-header .chat-name {
      margin-left: 12px;
      font-size: 1.1rem;
      font-weight: 500;
    }
    .header-actions {
      margin-left: auto;
      display: flex;
      gap: 12px;
    }
    .action-btn-header {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      color: var(--text-dark);
      position: relative;
    }
    .action-btn-header:hover {
      transform: scale(1.1);
      transition: transform 0.2s;
    }

    /* Chat area */
    .chat-container {
      flex: 1 1 auto;
      padding: 16px;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .message {
      max-width: 70%;
      padding: 8px 12px;
      border-radius: 16px;
      word-wrap: break-word;
      position: relative;
    }
    .message.sent {
      align-self: flex-end;
      background: var(--primary-color);
      color: white;
      border-bottom-right-radius: 4px;
    }
    .message.received {
      align-self: flex-start;
      background: #e0e0e0;
      color: var(--text-dark);
      border-bottom-left-radius: 4px;
    }
    .message .content {
      white-space: pre-wrap;
    }
    .message .time {
      font-size: 0.7rem;
      opacity: 0.6;
      margin-top: 4px;
      text-align: right;
    }

    .chat-input {
      flex: 0 0 auto;
      display: flex;
      align-items: center;
      padding: 8px 16px;
      border-top: 1px solid #ccc;
      background: #fff;
    }
    .chat-input .btn-emoji,
    .chat-input .btn-attach {
      background: none;
      border: none;
      font-size: 1.2rem;
      cursor: pointer;
      margin-right: 8px;
      color: var(--text-dark);
    }
    .chat-input input[type="text"] {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ccc;
      border-radius: 20px;
      outline: none;
    }
    .chat-input button.send-btn {
      background: var(--primary-color);
      border: none;
      color: white;
      padding: 8px 16px;
      margin-left: 8px;
      border-radius: 20px;
      cursor: pointer;
    }
    .chat-input button.send-btn:disabled {
      opacity: 0.6;
      cursor: default;
    }

    /* Notifications main content placeholder */
    .notifications-main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 1rem;
    }
    /* Notification detail */
    .notification-detail {
      display: flex;
      flex-direction: column;
      height: 100%;
    }
    .notification-detail .main-header {
      /* reuse header */
    }
    .notification-detail .notification-body {
      flex: 1;
      padding: 16px;
      overflow-y: auto;
    }
    .notification-detail .avatar-large {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin-bottom: 12px;
    }
    .notification-detail .open-chat-btn {
      background: var(--primary-color);
      border: none;
      color: #fff;
      padding: 8px 16px;
      border-radius: 20px;
      cursor: pointer;
      margin-top: 16px;
    }

    /* Placeholder when no item */
    .placeholder-chat {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #666;
      font-size: 1rem;
    }

    /* Scrollbar custom cho sidebar-content và chat-container */
    .sidebar-content::-webkit-scrollbar,
    .chat-container::-webkit-scrollbar {
      width: 6px;
    }
    .sidebar-content::-webkit-scrollbar-thumb,
    .chat-container::-webkit-scrollbar-thumb {
      background-color: var(--primary-color);
      border-radius: 3px;
    }
    .sidebar-content::-webkit-scrollbar-track,
    .chat-container::-webkit-scrollbar-track {
      background: #f1f1f1;
    }

    /* Responsive: ẩn sidebar trên mobile, show bottom-nav */
    @media (max-width: 768px) {
      .sidebar {
        display: none;
      }
      .main-content {
        width: 100%;
      }
      .bottom-nav {
        display: flex;
        justify-content: space-around;
        position: fixed;
        bottom: 0;
        width: 100%;
        background: var(--sidebar-bg);
        padding: 8px 0;
        z-index: 100;
      }
      .bottom-nav .icon-btn {
        width: 40px; height: 40px;
        background: #fff;
        color: var(--primary-color);
      }
    }
    /* Dark mode support */
    @media (prefers-color-scheme: dark) {
      body {
        background: #121212;
        color: #ddd;
      }
      .sidebar, .bottom-nav {
        background: #1e1e1e;
      }
      .sidebar .icon-btn {
        background: #333;
        color: var(--primary-color);
      }
      .main-content {
        background: #181818;
      }
      .main-header, .chat-input {
        background: #242424;
        border-color: #444;
      }
      .search-input {
        background: #333;
        color: #ddd;
        border-color: #555;
      }
      .sidebar-content {
        background: #242424;
        color: #ddd;
      }
      .sidebar-item {
        border-color: #333;
      }
      .chat-container {
        background: #181818;
      }
      .message.sent {
        background: var(--primary-color);
        color: #fff;
      }
      .message.received {
        background: #333;
        color: #ddd;
      }
      .chat-input input[type="text"] {
        background: #333;
        color: #ddd;
        border-color: #555;
      }
      .notification-item {
        border-color: #333;
      }
      .notification-item.unread {
        background: #2a2a2a;
      }
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <aside class="sidebar">
    <div class="profile">
      <img src="" alt="Your Avatar" class="avatar" id="sidebar-avatar">
      <span class="username">You</span>
    </div>
    <nav class="nav-icons">
      <button class="icon-btn" id="btn-match"><i class="fa-solid fa-heart-crack"></i></button>
      <button class="icon-btn" id="btn-message">
        <i class="fa-solid fa-comments"></i>
        <span class="badge" id="badge-message" hidden>0</span>
      </button>
      <button class="icon-btn" id="btn-notifications">
        <i class="fa-solid fa-bell"></i>
        <span class="badge" id="badge-notifications" hidden>0</span>
      </button>
      <button class="icon-btn" id="btn-settings"><i class="fa-solid fa-gear"></i></button>
    </nav>
    <div class="tab-container">
      <button class="tab-btn" data-tab="match">Match</button>
      <button class="tab-btn" data-tab="message">Message</button>
      <button class="tab-btn" data-tab="notifications">Notifications</button>
    </div>
    <div class="sidebar-content" id="sidebar-content">
      <!-- JS sẽ render nội dung tương ứng tab -->
    </div>
  </aside>

  <!-- MAIN CONTENT -->
  <main class="main-content" id="main-content">
    <!-- JS sẽ render header + body tùy tab -->
  </main>

  <!-- Bottom nav cho mobile -->
  <div class="bottom-nav" id="bottom-nav" style="display:none;">
    <button class="icon-btn" id="mb-btn-match"><i class="fa-solid fa-heart-crack"></i></button>
    <button class="icon-btn" id="mb-btn-message"><i class="fa-solid fa-comments"></i><span class="badge" id="mb-badge-message" hidden>0</span></button>
    <button class="icon-btn" id="mb-btn-notifications"><i class="fa-solid fa-bell"></i><span class="badge" id="mb-badge-notifications" hidden>0</span></button>
    <button class="icon-btn" id="mb-btn-settings"><i class="fa-solid fa-gear"></i></button>
  </div>

  <script>
    // ========== Dữ liệu mẫu (dummy) ==========
    window.matchData = [
      { id: 1, name: "Hà My", avatar: "https://i.pravatar.cc/300?img=5", age: 21, distance: "5 km away", hobbies: ["Badminton","Anime","Photography"] },
      { id: 2, name: "Trần Hà Linh", avatar: "https://i.pravatar.cc/300?img=6", age: 20, distance: "9 kilometers away", hobbies: ["Cook","Read book"] },
      // ... bạn có thể thêm vài object nữa để thử swipe
    ];
    window.inboxData = [
      { partnerId: 1, partnerName: "Hà My", partnerAvatar: "https://i.pravatar.cc/150?img=5", lastText: "Bạn: Chào Hà My!", unreadCount: 1 },
      { partnerId: 2, partnerName: "Trần Hà Linh", partnerAvatar: "https://i.pravatar.cc/150?img=6", lastText: "Mình đang xem...", unreadCount: 0 },
    ];
    window.notificationsData = [
      { id: 101, type: "match", avatar: "https://i.pravatar.cc/150?img=5", text: "Hà My liked you back. You can now chat!", isRead: false, relatedId: 1, timestamp: Date.now() - 3600*1000 },
      { id: 102, type: "like", avatar: "https://i.pravatar.cc/150?img=7", text: "Lan Anh liked your profile!", isRead: false, relatedId: null, timestamp: Date.now() - 7200*1000 },
    ];

    document.addEventListener("DOMContentLoaded", () => {
      const tabButtons = document.querySelectorAll(".tab-btn");
      const btnMatch = document.getElementById("btn-match");
      const btnMessage = document.getElementById("btn-message");
      const btnNotifications = document.getElementById("btn-notifications");
      const mbBtnMatch = document.getElementById("mb-btn-match");
      const mbBtnMessage = document.getElementById("mb-btn-message");
      const mbBtnNotifications = document.getElementById("mb-btn-notifications");
      let currentTab = "match";

      const badgeMessage = document.getElementById("badge-message");
      const badgeNotifications = document.getElementById("badge-notifications");
      const mbBadgeMessage = document.getElementById("mb-badge-message");
      const mbBadgeNotifications = document.getElementById("mb-badge-notifications");

      // Cập nhật badge ban đầu
      updateBadgeMessages();
      updateBadgeNotifications();
      checkMobileNav();

      function switchTab(tab) {
        currentTab = tab;
        // Cập nhật class active cho desktop tab-btn
        tabButtons.forEach(btn => btn.classList.toggle("active", btn.dataset.tab === tab));
        // Render sidebar và main tùy tab
        renderSidebarContent(tab);
        renderMainContent(tab);
        // Khi chuyển tab, nếu mobile, ẩn keyboard (nếu có)
      }

      // Bắt sự kiện click desktop
      tabButtons.forEach(btn => btn.addEventListener("click", () => switchTab(btn.dataset.tab)));
      btnMatch.addEventListener("click", () => switchTab("match"));
      btnMessage.addEventListener("click", () => switchTab("message"));
      btnNotifications.addEventListener("click", () => switchTab("notifications"));
      // Bắt sự kiện click mobile bottom-nav
      mbBtnMatch.addEventListener("click", () => switchTab("match"));
      mbBtnMessage.addEventListener("click", () => switchTab("message"));
      mbBtnNotifications.addEventListener("click", () => switchTab("notifications"));

      // Khi load lần đầu
      switchTab(currentTab);

      // Khi window resize, kiểm tra mobile nav
      window.addEventListener("resize", checkMobileNav);

      function checkMobileNav() {
        const bottomNav = document.getElementById("bottom-nav");
        if (window.innerWidth <= 768) {
          bottomNav.style.display = "flex";
        } else {
          bottomNav.style.display = "none";
        }
      }

      // ========== Render sidebar content ==========
      function renderSidebarContent(tab) {
        const container = document.getElementById("sidebar-content");
        container.innerHTML = "";
        if (tab === "match") {
          if (!window.matchData.length) {
            container.innerHTML = `<div class="placeholder-chat"><p>Không có match nào.</p></div>`;
          } else {
            window.matchData.forEach(item => {
              const div = document.createElement("div");
              div.className = "sidebar-item match-item";
              div.innerHTML = `
                <img src="${item.avatar}" alt="Avatar ${item.name}" class="avatar">
                <span class="name">${item.name}</span>
              `;
              div.addEventListener("click", () => {
                // Khi click match item: chuyển sang message và mở chat
                switchTab("message");
                openChatWith(item.id);
              });
              container.append(div);
            });
          }
        }
        else if (tab === "message") {
          if (!window.inboxData.length) {
            container.innerHTML = `<div class="placeholder-chat"><p>Chưa có cuộc trò chuyện nào.</p></div>`;
          } else {
            window.inboxData.forEach(conv => {
              const div = document.createElement("div");
              div.className = "sidebar-item message-item";
              div.innerHTML = `
                <img src="${conv.partnerAvatar}" alt="Avatar ${conv.partnerName}" class="avatar">
                <div class="text-group">
                  <span class="name">${conv.partnerName}</span>
                  <span class="preview">${conv.lastText}</span>
                </div>
                ${conv.unreadCount > 0 ? `<span class="badge">${conv.unreadCount}</span>` : ''}
              `;
              div.addEventListener("click", () => openChatWith(conv.partnerId));
              container.append(div);
            });
          }
        }
        else if (tab === "notifications") {
          if (!window.notificationsData.length) {
            container.innerHTML = `<div class="placeholder-chat"><p>Chưa có thông báo.</p></div>`;
          } else {
            window.notificationsData.forEach(nt => {
              const div = document.createElement("div");
              div.className = "notification-item" + (nt.isRead ? "" : " unread");
              const timeAgo = formatTimeAgo(nt.timestamp);
              div.innerHTML = `
                <img src="${nt.avatar}" alt="" class="avatar">
                <div class="text-group">
                  <div class="text">${nt.text}</div>
                  <div class="time">${timeAgo}</div>
                </div>
                <i class="fa-solid fa-chevron-right action"></i>
              `;
              div.addEventListener("click", () => {
                // mark read và xử lý click
                markNotificationRead(nt.id);
                handleNotificationClick(nt);
              });
              container.append(div);
            });
          }
        }
      }

      // ========== Render main content ==========
      function renderMainContent(tab) {
        const main = document.getElementById("main-content");
        main.innerHTML = "";
        if (tab === "match") {
          // Render 1 card match phía giữa
          const item = window.matchData[0];
          if (!item) {
            main.innerHTML = `<div class="placeholder-chat"><p>Hết người để match.</p></div>`;
            return;
          }
          const wrapper = document.createElement("div");
          wrapper.className = "card-wrapper";
          wrapper.style.display = "flex";
          wrapper.style.justifyContent = "center";
          wrapper.style.alignItems = "flex-start";
          wrapper.style.flexGrow = "1";
          wrapper.style.paddingTop = "20px";
          // Card HTML
          const hobbiesHTML = item.hobbies.map(h => `<span class="hobby" style="background:rgba(255,255,255,0.8);color:#333;padding:4px 8px;border-radius:12px;font-size:0.85rem;margin-right:6px;margin-bottom:6px;">${h}</span>`).join("");
          const card = document.createElement("div");
          card.className = "card";
          card.style.display = "flex";
          card.style.flexDirection = "column";
          card.style.alignItems = "center";
          card.style.width = "var(--card-width)";
          card.style.marginBottom = "40px";
          card.innerHTML = `
            <div class="image-wrapper" style="position:relative; width:100%; aspect-ratio:3/4; border-radius:16px; overflow:hidden; background:#ddd;">
              <img src="${item.avatar}" alt="Avatar ${item.name}" style="width:100%;height:100%;object-fit:cover;">
              <div class="overlay" style="position:absolute; bottom:0; left:0; width:100%; height:50%; background:linear-gradient(to top, rgba(0,0,0,0.6), transparent);"></div>
              <div class="card-info" style="position:absolute; bottom:16px; left:12px; color:#fff;">
                <h3 class="name" style="font-size:1.3rem; margin-bottom:4px;">${item.name}</h3>
                <p class="age-distance" style="font-size:1rem; margin-bottom:2px;">Age: ${item.age}</p>
                <p class="age-distance" style="font-size:1rem; margin-bottom:2px;">${item.distance}</p>
                <div class="hobbies" style="display:flex; flex-wrap:wrap;">${hobbiesHTML}</div>
              </div>
            </div>
            <div class="action-buttons" style="display:flex; gap:20px; margin-top:12px;">
              <button class="action-btn dislike" aria-label="Dislike" style="width:50px;height:50px;border-radius:50%;border:2px solid #333;background:#fff;color:#333;font-size:1.2rem;cursor:pointer;transition:transform 0.2s;"><i class="fa-solid fa-xmark"></i></button>
              <button class="action-btn like" aria-label="Like" style="width:50px;height:50px;border-radius:50%;border:2px solid var(--primary-color);background:#fff;color:var(--primary-color);font-size:1.2rem;cursor:pointer;transition:transform 0.2s;"><i class="fa-solid fa-heart"></i></button>
            </div>
          `;
          wrapper.append(card);
          main.append(wrapper);

          // Bạn có thể thêm JS cho nút like/dislike như animation:
          const likeBtn = card.querySelector(".like");
          const dislikeBtn = card.querySelector(".dislike");
          [likeBtn, dislikeBtn].forEach(btn => {
            btn.addEventListener("click", () => {
              btn.style.transform = "scale(0.9)";
              setTimeout(() => btn.style.transform = "", 150);
              // Mô phỏng match: nếu like, đưa vào notifications và inboxData
              if (btn.classList.contains("like")) {
                // Thêm notification dummy
                const newNt = {
                  id: Date.now(),
                  type: "match",
                  avatar: item.avatar,
                  text: `${item.name} liked you back. You can now chat!`,
                  isRead: false,
                  relatedId: item.id,
                  timestamp: Date.now()
                };
                window.notificationsData.unshift(newNt);
                updateBadgeNotifications();
                // Thêm vào inboxData
                const exists = window.inboxData.find(c=>c.partnerId===item.id);
                if (!exists) {
                  window.inboxData.unshift({
                    partnerId: item.id,
                    partnerName: item.name,
                    partnerAvatar: item.avatar,
                    lastText: "",
                    unreadCount: 0
                  });
                  updateBadgeMessages();
                }
              }
              // Bỏ item đầu tiên khỏi matchData (simulate swipe)
              window.matchData.shift();
              // Rerender main và sidebar match list
              renderSidebarContent("match");
              renderMainContent("match");
            });
          });
        }
        else if (tab === "message") {
          // Nếu chưa chọn chat, show placeholder; openChatWith sẽ render header+chat+input
          main.innerHTML = `<div class="placeholder-chat"><p>Chọn cuộc trò chuyện để bắt đầu chat.</p></div>`;
        }
        else if (tab === "notifications") {
          main.innerHTML = `<div class="notifications-main"><p>Chọn thông báo bên trái để xem chi tiết.</p></div>`;
        }
      }

      // ========== Hàm openChatWith (UI only) ==========
      function openChatWith(partnerId) {
        // mark unread = 0 trong inboxData
        const conv = window.inboxData.find(c => c.partnerId === partnerId);
        if (conv) {
          conv.unreadCount = 0;
          updateBadgeMessages();
          if (currentTab === "message") renderSidebarContent("message");
        }
        // Tìm partner info từ inboxData hoặc matchData cũ
        let partner = { name: "Unknown", avatar: "" };
        if (conv) {
          partner.name = conv.partnerName;
          partner.avatar = conv.partnerAvatar;
        } else {
          // fallback: tìm trong matchData (đã like) hoặc để mặc định
          partner.name = "Người dùng";
          partner.avatar = "";
        }
        const main = document.getElementById("main-content");
        main.innerHTML = "";

        // Header chat
        const header = document.createElement("div");
        header.className = "main-header chat-header";
        header.innerHTML = `
          <img src="${partner.avatar}" alt="Avatar ${partner.name}" class="avatar">
          <span class="chat-name">${partner.name}</span>
          <div class="header-actions">
            <button class="action-btn-header" aria-label="Voice call"><i class="fa-solid fa-phone"></i></button>
            <button class="action-btn-header" aria-label="Video call"><i class="fa-solid fa-video"></i></button>
            <button class="action-btn-header" aria-label="More options"><i class="fa-solid fa-ellipsis"></i></button>
          </div>
        `;
        main.append(header);

        // Chat container
        const chatContainer = document.createElement("div");
        chatContainer.className = "chat-container";
        // Dummy messages (mô phỏng)
        const fakeMessages = [
          { fromMe: false, text: "Chào bạn!", time: Date.now() - 600000 },
          { fromMe: true, text: "Chào " + partner.name + "!", time: Date.now() - 590000 },
        ];
        fakeMessages.forEach(msg => {
          const msgDiv = document.createElement("div");
          msgDiv.className = "message " + (msg.fromMe ? "sent" : "received");
          msgDiv.innerHTML = `<div class="content">${msg.text}</div><div class="time">${new Date(msg.time).toLocaleTimeString()}</div>`;
          chatContainer.append(msgDiv);
        });
        main.append(chatContainer);
        chatContainer.scrollTop = chatContainer.scrollHeight;

        // Chat input
        const inputBar = document.createElement("div");
        inputBar.className = "chat-input";
        inputBar.innerHTML = `
          <button class="btn-emoji" aria-label="Emoji"><i class="fa-regular fa-face-smile"></i></button>
          <button class="btn-attach" aria-label="Attach"><i class="fa-solid fa-image"></i></button>
          <input type="text" placeholder="Aa" id="chat-input-field">
          <button class="send-btn" disabled>Send</button>
        `;
        main.append(inputBar);
        const inputField = inputBar.querySelector("#chat-input-field");
        const sendBtn = inputBar.querySelector(".send-btn");
        inputField.addEventListener("input", () => {
          sendBtn.disabled = inputField.value.trim() === "";
        });
        sendBtn.addEventListener("click", () => {
          const text = inputField.value.trim();
          if (!text) return;
          const now = Date.now();
          const msgDiv = document.createElement("div");
          msgDiv.className = "message sent";
          msgDiv.innerHTML = `<div class="content">${text}</div><div class="time">${new Date(now).toLocaleTimeString()}</div>`;
          chatContainer.append(msgDiv);
          chatContainer.scrollTop = chatContainer.scrollHeight;
          inputField.value = "";
          sendBtn.disabled = true;
          // Cập nhật lastText trong inboxData
          if (conv) {
            conv.lastText = text;
            // render sidebar lại nếu đang ở tab message
            if (currentTab === "message") renderSidebarContent("message");
          }
        });
      }

      // ========== Notifications handlers ==========
      function markNotificationRead(id) {
        const nt = window.notificationsData.find(n => n.id === id);
        if (nt) nt.isRead = true;
        updateBadgeNotifications();
        if (currentTab === "notifications") renderSidebarContent("notifications");
      }
      function handleNotificationClick(nt) {
        // Ví dụ: nếu type match hoặc message, chuyển sang chat
        if (nt.type === "match" || nt.type === "message") {
          switchTab("message");
          if (nt.relatedId != null) {
            openChatWith(nt.relatedId);
          }
        } else {
          // Ví dụ type "like": chỉ show detail thông báo
          renderNotificationDetail(nt);
        }
      }
      function renderNotificationDetail(nt) {
        const main = document.getElementById("main-content");
        main.innerHTML = "";
        const detail = document.createElement("div");
        detail.className = "notification-detail";
        detail.innerHTML = `
          <div class="main-header">
            <button class="action-btn-header" id="back-from-noti" aria-label="Back"><i class="fa-solid fa-arrow-left"></i></button>
            <span style="margin-left:12px; font-weight:500;">Notification</span>
          </div>
          <div class="notification-body">
            <img src="${nt.avatar}" alt="" class="avatar-large">
            <p>${nt.text}</p>
            ${nt.relatedId ? `<button class="open-chat-btn">Chat ngay</button>` : ""}
          </div>
        `;
        main.append(detail);
        // Bắt event Back
        detail.querySelector("#back-from-noti").addEventListener("click", () => {
          switchTab("notifications");
        });
        // Bắt event Chat ngay nếu có
        const chatBtn = detail.querySelector(".open-chat-btn");
        if (chatBtn) {
          chatBtn.addEventListener("click", () => {
            switchTab("message");
            openChatWith(nt.relatedId);
          });
        }
      }

      // ========== Badge updates ==========
      function updateBadgeNotifications() {
        const count = window.notificationsData.filter(n => !n.isRead).length;
        if (count > 0) {
          badgeNotifications.textContent = count > 99 ? "99+" : count;
          badgeNotifications.hidden = false;
          mbBadgeNotifications.textContent = badgeNotifications.textContent;
          mbBadgeNotifications.hidden = false;
        } else {
          badgeNotifications.hidden = true;
          mbBadgeNotifications.hidden = true;
        }
      }
      function updateBadgeMessages() {
        const total = window.inboxData.reduce((sum, c) => sum + c.unreadCount, 0);
        if (total > 0) {
          badgeMessage.textContent = total > 99 ? "99+" : total;
          badgeMessage.hidden = false;
          mbBadgeMessage.textContent = badgeMessage.textContent;
          mbBadgeMessage.hidden = false;
        } else {
          badgeMessage.hidden = true;
          mbBadgeMessage.hidden = true;
        }
      }

      // ========== Utility ==========
      function formatTimeAgo(ts) {
        const diff = Date.now() - ts;
        const minutes = Math.floor(diff/60000);
        if (minutes < 60) return `${minutes} phút trước`;
        const hours = Math.floor(minutes/60);
        if (hours < 24) return `${hours} giờ trước`;
        const days = Math.floor(hours/24);
        return `${days} ngày trước`;
      }

      // ========== Search bar ví dụ (nếu muốn) ==========
      // Nếu muốn search trong match list:
      // Khi renderMatchSidebar, bạn có thể thêm 1 ô search ở sidebar-content đầu:
      // Nhưng vì UI only, bạn tuỳ chọn thêm.
    });
  </script>
</body>
</html>
